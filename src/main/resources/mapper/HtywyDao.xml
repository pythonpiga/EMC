<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.broad.emc.module.dao.HtywyDao">

    <select id="selectInfoList" resultType="com.broad.emc.module.vo.HtywyVo">
        select distinct
            (select sws_mc from ht_sws where sws_id=ht.sws_id) as sws,
            (select xm from rs_jx where dkxh=ht.ywy_id) as khjl,
            case when hzrylb=01 then '签单客户经理'
            else '主管'
            end as rylb,
            htbl,
            tcbl,
            case when (select bzlb from rs_jx where dkxh=ht.ywy_id)='y' then '在职'
            else '离职'
            end as type,
            parent_ywy_id as parentYwyid,
            flag,
            op_time as opTime
        from ht_htywy ht
        where  flag=1 and ht_sno=#{htsno} 

    </select>

    <select id="selectTcryHistoryList" resultType="com.broad.emc.module.vo.HtywyVo">
        select
            ht_sno,
            (select sws_mc from ht_sws where sws_id=ywy.sws_id) as sws,
            (select xm from rs_jx where dkxh=ywy.ywy_id) as khjl,
            case when hzrylb=01 then '签单客户经理'	else '主管'
                end as rylb,
            tcbl,
            case when (select bzlb from rs_jx where dkxh=ywy.ywy_id)='y' then '在职' else '离职'
                end as type,
            (select sws_mc from ht_sws where sws_id=(select DISTINCT sws_id from ht_htywy where ywy_id=ywy. parent_ywy_id and flag=0)  ) as swsOld,
            (select xm from rs_jx where dkxh=(select DISTINCT ywy_id from ht_htywy where ywy_id=ywy. parent_ywy_id and flag=0)) as khjlOld,
            case when (select DISTINCT hzrylb from ht_htywy where ywy_id=ywy. parent_ywy_id and flag=0)=01 then '签单客户经理'	else '主管'
                end as rylbOld,
            (select DISTINCT tcbl from ht_htywy where ywy_id=ywy. parent_ywy_id and flag=0) as tcblOld,
            case when (select DISTINCT bzlb from rs_jx where dkxh=(select DISTINCT ywy_id from ht_htywy where ywy_id=ywy. parent_ywy_id and flag=0) )='y' then '在职' else '离职'
                end as typeOld,
            op_time
        from  ht_htywy ywy WHERE ht_sno =#{htsno} and parent_ywy_id !=''

    </select>

    <insert id="insertTcry" useGeneratedKeys="true" parameterType="com.broad.emc.module.vo.HtywyVo">      
       insert into ht_htywy(
            id,
            ht_sno,
            sws_id,
            ywy_id,
            hzrylb,
            htbl,
            tcbl,
            type,
            parent_ywy_id,
            op_time,
            flag
        ) values (
            case  
                when (select ISNULL((select max(id) from ht_htywy), '')) ='0' then '1'
                else (select max(id)+1 from ht_htywy)
            end ,
            #{htsno},
            #{sws},
            (select dkxh  from rs_jx where xm=#{khjl} ),
            #{rylb},
            #{htbl},
            #{tcbl},
            #{type},
            (select dkxh  from rs_jx where xm=#{parentYwyXm} ),
            CONVERT(DATETIME, #{opTime}, 120),
            '1'
        )

    </insert>

    <update id="updateTcryByHtsno"  useGeneratedKeys="true" parameterType="com.broad.emc.module.vo.HtywyVo">
        UPDATE ht_htywy 
            SET flag='0',
            op_time=CONVERT(DATETIME, #{opTime}, 120)
        WHERE
            ht_sno =#{htsno} and ywy_id=(select  dkxh  from rs_jx where xm=#{parentYwyXm} )
        
    </update>


</mapper>